name: Website Health Check

# Automatische √úberpr√ºfung der Website-Verf√ºgbarkeit und SEO-Dateien

on:
  # T√§glich um 08:00 UTC (09:00/10:00 √∂sterreichische Zeit)
  schedule:
    - cron: '0 8 * * *'
  
  # Manuell triggern via GitHub Actions UI
  workflow_dispatch:

jobs:
  health-check:
    runs-on: ubuntu-latest
    
    steps:
      - name: Check Website Availability
        run: |
          echo "üåê Checking website availability..."
          
          status=$(curl -s -o /dev/null -w "%{http_code}" https://flaechenfrei.at)
          
          if [ "$status" = "200" ]; then
            echo "‚úÖ Website is UP (HTTP $status)"
          else
            echo "‚ùå Website is DOWN (HTTP $status)"
            exit 1
          fi
      
      - name: Check Robots.txt
        run: |
          echo "ü§ñ Checking robots.txt..."
          
          status=$(curl -s -o /dev/null -w "%{http_code}" https://flaechenfrei.at/robots.txt)
          
          if [ "$status" = "200" ]; then
            echo "‚úÖ robots.txt is accessible"
            
            # Verify key crawlers are allowed
            content=$(curl -s https://flaechenfrei.at/robots.txt)
            
            if echo "$content" | grep -q "User-agent: Googlebot"; then
              echo "‚úÖ Googlebot is configured"
            fi
            
            if echo "$content" | grep -q "User-agent: OAI-SearchBot"; then
              echo "‚úÖ ChatGPT crawler is configured"
            fi
          else
            echo "‚ùå robots.txt not accessible (HTTP $status)"
            exit 1
          fi
      
      - name: Check Sitemap.xml
        run: |
          echo "üó∫Ô∏è Checking sitemap.xml..."
          
          status=$(curl -s -o /dev/null -w "%{http_code}" https://flaechenfrei.at/sitemap.xml)
          
          if [ "$status" = "200" ]; then
            echo "‚úÖ sitemap.xml is accessible"
            
            # Count URLs in sitemap
            url_count=$(curl -s https://flaechenfrei.at/sitemap.xml | grep -c "<loc>")
            echo "üìä Sitemap contains $url_count URLs"
            
            if [ "$url_count" -gt 100 ]; then
              echo "‚úÖ Sitemap has sufficient coverage ($url_count URLs)"
            else
              echo "‚ö†Ô∏è Sitemap has fewer URLs than expected"
            fi
          else
            echo "‚ùå sitemap.xml not accessible (HTTP $status)"
            exit 1
          fi
      
      - name: Check IndexNow Key File
        run: |
          echo "üîë Checking IndexNow key file..."
          
          key_url="https://flaechenfrei.at/4360887d417651be8e892bc97ab0625dce0349081491ae37c119b83258d0df32.txt"
          status=$(curl -s -o /dev/null -w "%{http_code}" "$key_url")
          
          if [ "$status" = "200" ]; then
            echo "‚úÖ IndexNow key file is accessible"
            
            key_content=$(curl -s "$key_url")
            if [ "$key_content" = "4360887d417651be8e892bc97ab0625dce0349081491ae37c119b83258d0df32" ]; then
              echo "‚úÖ IndexNow key is valid"
            else
              echo "‚ùå IndexNow key content is invalid"
              exit 1
            fi
          else
            echo "‚ùå IndexNow key file not accessible (HTTP $status)"
            exit 1
          fi
      
      - name: Check Favicon
        run: |
          echo "üé® Checking favicon..."
          
          status=$(curl -s -o /dev/null -w "%{http_code}" https://flaechenfrei.at/favicon.png)
          
          if [ "$status" = "200" ]; then
            echo "‚úÖ Favicon is accessible"
          else
            echo "‚ùå Favicon not accessible (HTTP $status)"
            exit 1
          fi
      
      - name: Check IndexNow API
        run: |
          echo "üîå Testing IndexNow API endpoint..."
          
          response=$(curl -s -X POST https://flaechenfrei.at/api/indexnow/submit-url \
            -H "Content-Type: application/json" \
            -d '{"url": "https://flaechenfrei.at/"}' \
            -w "\nHTTP_CODE:%{http_code}")
          
          http_code=$(echo "$response" | grep "HTTP_CODE:" | cut -d: -f2)
          
          if [ "$http_code" = "200" ] || [ "$http_code" = "202" ]; then
            echo "‚úÖ IndexNow API is functional (HTTP $http_code)"
          elif [ "$http_code" = "502" ]; then
            echo "‚ö†Ô∏è IndexNow API returned 502 (upstream service issue - this is expected behavior)"
          else
            echo "‚ùå IndexNow API returned unexpected status: $http_code"
            exit 1
          fi
      
      - name: SSL Certificate Check
        run: |
          echo "üîí Checking SSL certificate..."
          
          expiry=$(echo | openssl s_client -servername flaechenfrei.at -connect flaechenfrei.at:443 2>/dev/null | openssl x509 -noout -enddate | cut -d= -f2)
          
          echo "üìÖ SSL Certificate expires: $expiry"
          
          # Check if certificate is valid (openssl will exit with error if not)
          if echo | openssl s_client -servername flaechenfrei.at -connect flaechenfrei.at:443 2>/dev/null | openssl x509 -noout -checkend 2592000; then
            echo "‚úÖ SSL certificate is valid for at least 30 more days"
          else
            echo "‚ö†Ô∏è SSL certificate expires within 30 days!"
          fi
      
      - name: Performance Check
        run: |
          echo "‚ö° Checking page load time..."
          
          load_time=$(curl -o /dev/null -s -w '%{time_total}\n' https://flaechenfrei.at)
          
          echo "üìä Page load time: ${load_time}s"
          
          # Check if load time is under 3 seconds
          if (( $(echo "$load_time < 3.0" | bc -l) )); then
            echo "‚úÖ Page loads in under 3 seconds"
          else
            echo "‚ö†Ô∏è Page load time is slower than expected"
          fi
      
      - name: Summary
        if: success()
        run: |
          echo ""
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "‚úÖ ALL HEALTH CHECKS PASSED"
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "üåê Website: HEALTHY"
          echo "üîí SSL: VALID"
          echo "ü§ñ SEO Files: ACCESSIBLE"
          echo "üîå APIs: FUNCTIONAL"
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
