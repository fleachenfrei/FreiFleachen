name: IndexNow Auto-Submit

# Automatisches Submitten der Sitemap an IndexNow nach erfolgreichem Railway Deployment

on:
  # Automatisch nach jedem Push auf main branch (nach Railway Deployment)
  push:
    branches: [ main ]
  
  # Manuell triggern via GitHub Actions UI
  workflow_dispatch:
  
  # Nach erfolgreichem Workflow (z.B. health-check)
  workflow_run:
    workflows: ["Website Health Check"]
    types:
      - completed

jobs:
  submit-sitemap:
    runs-on: ubuntu-latest
    # Nur ausfÃ¼hren wenn Health Check erfolgreich war
    if: ${{ github.event_name == 'workflow_dispatch' || github.event_name == 'push' || (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success') }}
    
    steps:
      - name: Wait for Railway Deployment
        if: github.event_name == 'push'
        run: |
          echo "â³ Waiting 60 seconds for Railway deployment to complete..."
          sleep 60
          echo "âœ… Railway deployment should be ready now"
      
      - name: Verify Website is Live
        run: |
          echo "ğŸ” Verifying website is accessible..."
          
          max_attempts=5
          attempt=1
          
          while [ $attempt -le $max_attempts ]; do
            # Follow redirects with -L flag
            status=$(curl -L -s -o /dev/null -w "%{http_code}" https://flaechenfrei.at)
            
            # Accept 2xx (success) and 3xx (redirect) as valid responses
            if [[ "$status" =~ ^(2|3)[0-9]{2}$ ]]; then
              echo "âœ… Website is live and accessible (HTTP $status)"
              break
            else
              echo "â³ Attempt $attempt/$max_attempts: Website returned HTTP $status, waiting 15 seconds..."
              sleep 15
              attempt=$((attempt + 1))
            fi
          done
          
          # Fail if still not accessible after all attempts
          if [[ ! "$status" =~ ^(2|3)[0-9]{2}$ ]]; then
            echo "âŒ Website is not accessible after $max_attempts attempts (HTTP $status)"
            exit 1
          fi
      
      - name: Submit Sitemap to IndexNow
        id: indexnow
        run: |
          echo "ğŸš€ Submitting sitemap to IndexNow..."
          
          response=$(curl -s -X POST https://flaechenfrei.at/api/indexnow/submit-sitemap \
            -H "Content-Type: application/json" \
            -w "\nHTTP_CODE:%{http_code}")
          
          http_code=$(echo "$response" | grep "HTTP_CODE:" | cut -d: -f2)
          body=$(echo "$response" | sed '/HTTP_CODE:/d')
          
          echo "Response: $body"
          echo "HTTP Status: $http_code"
          
          if [ "$http_code" = "200" ] || [ "$http_code" = "202" ]; then
            echo "âœ… Sitemap successfully submitted to IndexNow!"
            echo "All 120+ priority URLs have been sent to Bing, Yandex, and DuckDuckGo"
            echo "INDEXNOW_STATUS=success" >> $GITHUB_ENV
            echo "INDEXNOW_MESSAGE=Submitted to search engines" >> $GITHUB_ENV
          else
            echo "âŒ IndexNow submission failed with HTTP $http_code"
            echo "Response: $body"
            
            if [ "$http_code" = "502" ] || [ "$http_code" = "503" ] || [ "$http_code" = "504" ]; then
              echo "âš ï¸ This is a temporary API outage - URLs were NOT submitted"
              echo "ğŸ’¡ SOLUTION: Manually re-run this workflow via GitHub Actions"
              echo "   Or wait for the next scheduled health check run"
              echo "INDEXNOW_STATUS=failed_temporary" >> $GITHUB_ENV
              echo "INDEXNOW_MESSAGE=API temporarily unavailable (HTTP $http_code)" >> $GITHUB_ENV
            else
              echo "âš ï¸ This indicates a configuration or API issue"
              echo "ğŸ’¡ SOLUTION: Check IndexNow key and domain configuration"
              echo "INDEXNOW_STATUS=failed_config" >> $GITHUB_ENV
              echo "INDEXNOW_MESSAGE=Configuration error (HTTP $http_code)" >> $GITHUB_ENV
            fi
            
            # FAIL the workflow - green checkmark only when URLs are actually submitted
            exit 1
          fi
      
      - name: Verify IndexNow Key File
        run: |
          echo "ğŸ”‘ Verifying IndexNow key file..."
          
          key_response=$(curl -s https://flaechenfrei.at/4360887d417651be8e892bc97ab0625dce0349081491ae37c119b83258d0df32.txt)
          expected_key="4360887d417651be8e892bc97ab0625dce0349081491ae37c119b83258d0df32"
          
          if [ "$key_response" = "$expected_key" ]; then
            echo "âœ… IndexNow key file is accessible and valid"
          else
            echo "âŒ IndexNow key file verification failed!"
            echo "Expected: $expected_key"
            echo "Got: $key_response"
            exit 1
          fi
      
      - name: Summary
        if: always()
        run: |
          echo "ğŸ“Š Deployment Summary:"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… Website: https://flaechenfrei.at"
          echo "âœ… Sitemap: https://flaechenfrei.at/sitemap.xml"
          echo "âœ… Robots.txt: https://flaechenfrei.at/robots.txt"
          
          # Display IndexNow status based on actual result
          if [ "$INDEXNOW_STATUS" = "success" ]; then
            echo "âœ… IndexNow: $INDEXNOW_MESSAGE"
          elif [ "$INDEXNOW_STATUS" = "failed_temporary" ]; then
            echo "âŒ IndexNow: $INDEXNOW_MESSAGE"
          elif [ "$INDEXNOW_STATUS" = "failed_config" ]; then
            echo "âŒ IndexNow: $INDEXNOW_MESSAGE"
          else
            echo "â“ IndexNow: Status unknown (check logs)"
          fi
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          
          if [ "$INDEXNOW_STATUS" = "success" ]; then
            echo "ğŸ¯ Next Steps:"
            echo "1. Verify in Bing Webmaster Tools"
            echo "2. Check Google Search Console"
            echo "3. Monitor indexing progress (24-48 hours)"
          elif [ "$INDEXNOW_STATUS" = "failed_temporary" ]; then
            echo "âš ï¸ RETRY REQUIRED:"
            echo "1. IndexNow API was temporarily down"
            echo "2. Re-run this workflow manually via GitHub Actions"
            echo "3. Or wait for the next scheduled health check (daily at 08:00 UTC)"
            echo ""
            echo "Note: Website deployed successfully - only IndexNow submission failed"
          elif [ "$INDEXNOW_STATUS" = "failed_config" ]; then
            echo "âŒ ACTION REQUIRED:"
            echo "1. IndexNow submission failed due to configuration error"
            echo "2. Verify IndexNow key file is accessible"
            echo "3. Check server logs for details"
            echo "4. Fix the issue and re-deploy"
          fi
